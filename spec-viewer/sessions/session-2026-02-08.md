# SpecReader Development Session - February 8, 2026

## Overview

Created a self-contained OpenSpec document viewer optimized for reading GitHub-hosted specs on tablets. The app provides a clean reading experience with branch navigation, file filtering, and beautiful typography.

## Implementation Decisions

### Single File Architecture
- Chose to build as a single HTML file with embedded CSS and JavaScript
- Makes deployment trivial - just open the file in any browser
- All dependencies (Marked.js, fonts) loaded via CDN
- Simplifies GitHub Pages deployment

### API Strategy
- Uses unauthenticated GitHub API to avoid complexity
- Accepts rate limiting trade-off (60 req/hour) for simplicity
- Could be enhanced with token support for private repos/higher limits
- Used raw content API for better performance with large files

### Typography Choices
- **Source Serif 4** for body text - highly readable serif font
- **JetBrains Mono** for code blocks - excellent code font with ligatures
- **DM Sans** for UI elements - clean, modern sans-serif
- Warm color palette (#FAF8F5 background, #C05D3C accent) instead of harsh whites
- Generous line-height (1.85) for comfortable reading

### Branch Navigation
- Initially built without branch support
- Added as first enhancement after initial implementation
- Branch selector placed in sidebar for contextual proximity to file tree
- Fetches branches with pagination to handle repos with many branches
- Smart default branch detection and display
- Maintains context when switching (tries to reload same file)

### File Tree Structure
- Built nested folder structure from flat file paths
- Auto-expands first level of folders for immediate visibility
- Supports unlimited nesting depth
- Filters for common spec file extensions

### Responsive Approach
- Mobile-first breakpoints at 860px and 500px
- Sidebar becomes slide-out drawer on mobile
- TOC hidden on screens < 1100px to preserve reading space
- Touch-optimized tap targets (minimum 44px)

## Technical Insights

### Markdown Rendering
- Used Marked.js library for robust GitHub Flavored Markdown support
- Configured to disable header IDs initially (we add them for TOC)
- Extract first H1 from content to use as title
- Remove extracted H1 from body to avoid duplication

### Image Resolution
- Relative images in markdown need special handling
- Used regex to rewrite relative image URLs to point to `raw.githubusercontent.com`
- Preserve directory context from current file path
- Absolute URLs left unchanged

### State Management
- Simple global state variables for repo info and current file
- No framework needed - vanilla JS state handling sufficient
- Branch list cached after first fetch

### TOC Generation
- Only show TOC if document has 3+ headings
- Dynamically inject IDs into headings for scroll targets
- Floating positioned to not interfere with reading
- Smooth scroll behavior for better UX

## Issues Encountered

### CSS Escape for File Paths
- File paths can contain special characters that break selectors
- Used `CSS.escape()` when selecting file items by path
- Prevents errors with files containing brackets, quotes, etc.

### Branch Switching Edge Cases
- Need to handle case where current file doesn't exist on new branch
- Fallback chain: same file → README → welcome screen
- Prevents jarring empty state

### Mobile Sidebar Overlay
- Required separate overlay div for backdrop
- Click handler on overlay to close sidebar
- Z-index management between sidebar (90) and overlay (89)

## Code Quality Notes

### Clean Separation
- CSS custom properties for theming (easy to customize)
- Modular functions with single responsibilities
- Event handlers kept simple, delegating to named functions

### Performance
- Recursive file tree fetch (GitHub API limit: 100k files)
- Pagination for branches (capped at 1000 for safety)
- Minimal DOM manipulation - rebuild rather than update

### Error Handling
- Toast notifications for user-facing errors
- Graceful fallbacks (try default branch, then main, then master)
- Failed file loads don't crash the app

## Enhancement: URL Query Params & Share Button

Added deep linking support so spec views can be shared and bookmarked:
- URL updates via `history.replaceState` as user navigates (repo, branch, file)
- On page load, `initFromURL()` parses query params and auto-loads the view
- Share button in article header copies full URL to clipboard with "Copied!" feedback
- Branch param only included when not on default branch (cleaner URLs)
- `pendingFile` state variable bridges the gap between URL parsing and async repo loading

## Enhancement: Light/Dark Theme Toggle

Added theme switching with system preference detection:

### Design Decisions
- Used `data-theme` attribute on `<html>` rather than class toggle — cleaner selector specificity
- Dark palette maintains the warm character of the light theme (not cold blue-blacks)
- Dark accent shifted to `#E07A5A` (lighter/warmer) for better contrast on dark backgrounds
- Code blocks get their own `--code-block-bg`/`--code-block-text` variables since they need inverted treatment in light mode but muted treatment in dark

### Implementation Details
- `initTheme()` runs before DOM content loads to prevent flash of wrong theme
- Checks localStorage first (explicit user choice), falls back to `prefers-color-scheme` media query
- Hardcoded RGBA backgrounds (header, loading overlay, TOC) extracted to `--header-bg` variable so both themes work
- Moon icon shown in light mode, sun icon in dark mode — shows what you'll switch *to*

### Gotchas
- The `.file-item:hover` used hardcoded `rgba(192,93,60,.06)` — works acceptably in both themes since the accent hue is similar
- Toast notification background stays accent-colored in both themes (intentional — it's an overlay)

## Lessons Learned

- Single-file apps are incredibly portable and easy to deploy
- Warm color palettes are easier on eyes than stark white backgrounds
- Branch context is important when reviewing specs across versions
- GitHub API rate limits are acceptable for read-only personal use
- Typography matters hugely for reading experience
- Auto-loading README provides good default behavior
- CSS custom properties make theme switching trivial when set up from the start
- System preference detection (`prefers-color-scheme`) is a good default but should always be overridable
- Deep linking via query params is essential for any document viewer — makes sharing effortless

## Files Modified

- `spec-viewer/index.html` - complete app implementation with theme and deep linking support
- `spec-viewer/spec/functionality.md` - updated feature documentation
- `spec-viewer/sessions/session-2026-02-08.md` - updated session notes
